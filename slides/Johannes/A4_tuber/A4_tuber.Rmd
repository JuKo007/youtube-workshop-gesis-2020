---
title: "Automatic sampling and analysis of YouTubeData"
subtitle: "Collecting data with the tuber package for R"
author: "Julian Kohne<br />Johannes Breuer<br />M. Rohangis Mohseni"
date: "2020-02-10"
location: "GESIS, Cologne, Germany"
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: ["default", "default-fonts", "../workshop.css"]
    nature:
      highlightStyle: "github"
      highlightLines: true
      countIncrementalSlides: false
---
layout: true

```{r setup, include = F}
if (!require(easypackages)) install.packages("easypackages")
library(easypackages)

packages("knitr", "rmarkdown", "tidyverse", "kableExtra", "hadley/emo", "tuber", prompt = F)

options(htmltools.dir.version = FALSE, stringsAsFactors = F)

opts_chunk$set(echo = TRUE, fig.align = "center")

```

<div class="my-footer">
  <div style="float: left;"><span>`r gsub("<br />", ", ", gsub("<br /><br />|<a.+$", "", metadata$author))`</span></div>
  <div style="float: right;"><span>`r metadata$location`, `r metadata$date`</span></div>
  <div style="text-align: center;"><span>`r gsub(".+<br />", " ", metadata$subtitle)`</span></div>
</div>

<style type="text/css">

pre {
  font-size: 10px
}
</style>

---

# The `tuber` package

With the [`tuber` package](https://github.com/soodoku/tuber) you can access the *YouTube* API via `R`. The author of the package has written a short [vignette](https://cran.r-project.org/web/packages/tuber/vignettes/tuber-ex.html) to introduce some of its main functions.

Essentially, there are three main units of analysis for which you can access data with the `tuber` package:

- Videos
- Channels
- Playlists

In this workshop, we will focus on individual **videos**.

---

# Setup

```{r packages, eval = F}
install.packages("tuber")
install.packages("tidyverse")
library(tuber)
library(tidyverse)
options(stringsAsFactors = FALSE)
```

---

# Excursus: Keep your secrets secret

If you save your API credentials in an R script, anyone who has that script can potentially use your API key. This can affect your quota and might even cause costs for you.

If you use R environment variables, your credentials won't be shared if you share your scripts. However, the information is still stored in a plain text file. You can run `usethis::edit_r_environ()` to see its contents.

One way of keeping your credentials safer is using the `keyring` package.

```{r keyring setup, eval = F}
install.packages("keyring")
library(keyring)
```

---

# Excursus: The `keyring` package

To store your credentials in an encrypted password-protected keyring you first need to create a new keyring.

```{r create keyring, eval = F}
keyring_create("YouTube_API")
```

You will then be prompted to set a password for this keyring. As always: This password should ideally be easy to remember (for you) but hard to guess (for anyone else). You might want to write it down or store it in your password manager (if you use one). In the next step, you can store your *YouTube* app secret in the keyring.
```{r set key, eval = F}
key_set("app_secret", 
        keyring ="YouTube_API")
```

When you are prompted to enter the password now you should enter your app secret. At the end of your script, you should lock the keyring again.
```{r lock keyring, eval = F}
keyring_lock("YouTube_API")
```

---

# Authenticate your app

```{r authenticate plain, eval = F}
yt_oauth(app_id = "my_app_id", # paste your app ID here
         app_secret = "my_app_secret", # paste your app secret here
         token="")
```
or, if you stored your app secret in a keyring

```{r authenticate keyring, eval = F}
yt_oauth(app_id = "my_app_id",  # paste your app ID here
         app_secret = key_get("app_secret", keyring ="YouTube_API"),
         token="")
```

---

# Authentication

When running the `yt_oauth()` function there will be a prompt in the console asking you to save the access token in a file. If you select "Yes", `tuber` will create a local file (in your working directory) to cache [OAuth](https://en.wikipedia.org/wiki/OAuth) access credentials between `R` sessions. The token stored in this file will be valid for one hour (and can be automatically refreshed). Doing this makes sense if you know you will be running multiple `R` sessions that need your credentials (example: knitting an `RMarkdown` document). 

Similar to the app key and secret, you should never share the `.httr-oauth` file as it can be read in `R` using `read_RDS()` (the file contains a list list with all information needed for OAuth, including your app key and secret). Hence, it is usually ok (and safer) to select "No" when asked whether to store a local `.httr-oauth` file. 
---

# App permissions

After making your choice regarding the `.httr-oauth` file, a browser window should open, prompting you to log in with your *Google* account and to give permissions. *Google* will probably tell you that it is not safe to grant the app access to your account. However, since you created the app and presumably are its sole user, you can go ahead and trust yourself: Click "Extended", and then "Accept". After that, you can close the browser and return to `R`.

---

# Channel statistics

You can find the channel ID by searching on the *YouTube* website and then choosing Type = Channel from the options in the filter menu. When you click on the channel you want in the search results you see the channel ID at the end of the URL (after "/channel/").

```{r channel stats}
hadley_stats <- get_channel_stats("UCxOhDvtaoXDAB336AolWs3A")
```

---

# Channel statistics

`get_channel_stats` returns a list which can then be wrangled into a dataframe (tibble).

```{r YouTube oauth, echo = F}
yt_oauth()
```

```{r channel stats to df}
hadley_stats_df <- hadley_stats$statistics %>% 
  as_tibble() %>% 
  mutate_at(vars(-hiddenSubscriberCount), as.numeric) %>% 
  mutate(channel_id = hadley_stats$id,
         channel_name = hadley_stats$snippet$title,
         channel_published = hadley_stats$snippet$publishedAt)

hadley_stats_df

```

---

# Video statistics

```{r video stats}
dayum_stats <- get_stats("DcJFdCmN98s")

dayum_stats <- dayum_stats %>%
  as_tibble() %>% 
  mutate_at(vars(-id), as.numeric)

dayum_stats
```

---

# Searching video IDs

`tuber` provides the function `yt_search()` to use the API to search *YouTube*. However, using this function is extremely costly in terms of API queries. While the quota costs for search queries are, indeed, higher than those for other types of queries according to the [*YouTube* Data API Quota Calculator](https://developers.*Google*.com/youtube/v3/determine_quota_cost), this may also be due to the way in which the `yt_search()` function sends the GET requests to the API.

A single search query with the `yt_search()` function can easily exceed your daily query limit (even if you use the function argument `max_results` to limit the number of search results). Hence, we would recommend not to use the `yt_search()` function

---

# Searching video IDs

There are two alternatives to using the `yt_search()` function from the `tuber` package to search for *YouTube* video IDs:

1. Manual search via the *YouTube* website: This works well for a small number of videos but is not really feasible if you want a large number of video IDs for your analyses.

2. Web scraping: There are no ready-made solutions for scraping YouTube with `R`. While an introduction to web scraping would be beyond the scope of this workshop, we have created an `R` script for scraping *YouTube* search results which you can find in the `scripts` folder of the *GitHub* repo. 

NB: Although [Freelon, 2018](https://www.tandfonline.com/doi/abs/10.1080/10584609.2018.1477506?journalCode=upcp20) rightly argues that researchers interested in social media and other internet data should learn how to scrape the web in what he calls the "post-API age", you should use this method with caution (as it might, e.g., get your IP address blocked if you overuse it). Also keep in mind that your web scraping code may stop working if the HTML code of the website changes.

---

# Other useful `tuber` functions

`get_video_details("video_id")`: list with metadata for the video (e.g., title, description, tags) 

---

class: center, middle

# [Exercise](https://jobreu.github.io/tidyverse-workshop-gesis-2019/exercises/A5_DataWrangling1_exercises_question.html) time `r ji("weight_lifting_woman")``r ji("muscle")``r ji("running_man")``r ji("biking_man")`

## [Solutions](https://jobreu.github.io/tidyverse-workshop-gesis-2019/solutions/A5_DataWrangling1_exercises_solution.html)